Note: This vector has been mitigated by the March 2020 Windows security updates, which changed behavior relating to hard links.

The **Hyper-V Administrators** group has full access to all Hyper-V features. If **Domain Controllers (DCs)** are virtualized, Hyper-V admins effectively have Domain Admin-level capabilities.
- Hyper-V admins can create a **clone of a live DC**.
- Extract **NTLM password hashes** for all users in the domain.
---
### impact:
- Escalate to SYSTEM on any machine using Hardlink abuse  to write into an _arbitrary file overwrite_, which is one of the cleanest paths to **SYSTEM**.
- dump NTLM hash for any user within  virtualized DCs

### Requirements
- hyper-v admin
- decoder's script hyperv-eop
- path to privileged service like: 
```shell-session
C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe
```

---
##  exploit steps
- Mount the virtual disk **offline** to access `NTDS.dit`.
- Reference: [Hyper-V Admin to System Blog](https://decoder.cloud/2020/01/20/from-hyper-v-admin-to-system/)
1. create a hard link to system process
2. If the operating system is vulnerable to [CVE-2018-0952](https://www.tenable.com/cve/CVE-2018-0952) or [CVE-2019-0841](https://www.tenable.com/cve/CVE-2019-0841), we can leverage this to gain SYSTEM privileges. Otherwise, we can try to take advantage of an application on the server that has installed a service running in the context of SYSTEM, which is startable by unprivileged users.
---
### Scenario:
## 2. Exploiting VM Deletion (`vmms.exe`)

- `vmms.exe` restores original file permissions on `.vhdx` files as `NT AUTHORITY\SYSTEM`.
- Attack:
  1. Delete the `.vhdx` file.
  2. Create a **native hard link** to a **protected SYSTEM file**.
  3. Hyper-V admin gains **full permissions** on the target file.

## 3. Target File Example: Mozilla Maintenance Service

- Example target: **Firefox’s maintenance service**
  
```
C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe
```

- Use [Hyper-V NT Hard Link PoC](https://raw.githubusercontent.com/decoder-it/Hyper-V-admin-EOP/master/hyperv-eop.ps1) to grant **full permissions** on this file.

---
## 4. Taking Ownership

- After permissions are granted:

```
C:\htb> takeown /F "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

- You now have **full control** of the file.

---

## 5. Exploit Execution

1. Replace the file with a **malicious `maintenanceservice.exe`**.
2. Start the service to gain **SYSTEM command execution**:

```
C:\htb> sc.exe start MozillaMaintenance
```

- ⚠️ Note: Mitigated by **March 2020 Windows security updates**, which changed hard link behavior.

---

### References

```
- Hyper-V Administrators Group: https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#hyper-v-administrators
- Managing Hyper-V Features: https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/use/manage-virtual-machines
- Blog: Hyper-V Admin to System: https://decoder.cloud/2020/01/20/from-hyper-v-admin-to-system/
- CVE-2018-0952: https://www.tenable.com/cve/CVE-2018-0952
- CVE-2019-0841: https://www.tenable.com/cve/CVE-2019-0841
```
